
1.	目的
指导软件工程持续集成过程执行，加快项目研发迭代速度，提升研发集成效率，确保尽早发现问题，从而有效降低成本，减少返工，缩短项目周期，提高产品质量。
2.	适用范围
本指导书适用于本公司内所有软件项目的持续集成。第三部分的持续集成环境搭建主要指导维护人员进行Jenkins搭建，自动构建及自动部署主要指导开发人员进行持续集成。
3.	术语定义
	CI(Continuous Integration)：持续集成。持续集成强调开发人员提交了新代码之后，立刻进行构建、（单元）测试。根据测试结果，我们可以确定新代码和原有代码能否正确地集成在一起。
4.	角色与职责
在整个持续集成活动中，集成工程师依据持续集成环境搭建步骤，完成整个持续集成环境的搭建和调试，并保证持续集成环境的稳定；环境搭建交付后，集成工程师通知各团队或项目进行持续集成过程的执行，各团队SM参照持续集成指导书，完成各项目的持续集成过程配置，并完成对应的持续集成工作。集成工程师按照迭代，每个迭代进行持续集成过程执行检查，并填写持续集成状态表，保持每个迭代一个状态结果表。
5.	指导书
5.1.	持续集成环境搭建(集成工程师)
5.1.1安装目录规划
初次搭建持续集成环境，需要考虑规划合理的目录结构，以方便后期更新和维护持续集成平台，以下是建议的目录结构：
 
5.1.2软件工具安装
在Windows环境下，下载和安装最新版的JDK、Jenkins、Maven、Tomcat，下载链接参考下表的官方发布地址：
文件名称	链接地址
JDK	http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html
Jenkins.war	https://jenkins.io/download/
Tomcat
（免安装版）	http://tomcat.apache.org/download-90.cgi
Maven	http://maven.apache.org/download.cgi
5.1.3系统环境配置
变量名	变量值	
JAVA_HOME	存放JDK的物理路径
CLASSPATH	.;%JAVA_HOME%\lib;%JAVA_HOME%\lib\tools.jar
PATH	%JAVA_HOME%\bin;%JAVA_HOME%\jre\bin;
MAVEN_HOME	存放Maven的物理路径
PATH	%MAVEN_HOME%\bin;
JENKINS_HOME	存放Jenkins工作空间的物理路径
备注：JAVA_HOME、CLASSPATH是配置JDK的环境变量；JENKINS_HOME是配置Jenkins的工作空间，里面主要存放的是各工程项目的源文件和构建历史记录；MAVEN_HOME是配置Maven工具的环境变量，该工具为Jenkins构建Maven工程所使用。
5.1.4 Tomcat配置
配置文件	配置内容
Tomcat文件夹
/conf/server.xml	端口号：默认为8080，可根据具体需要修改
Tomcat文件夹/conf/tomcat-users.xml	管理员访问权限：
<role rolename="manager-gui"/>
<user username="admin" password="password" roles="manager-gui"/>
Tomcat文件夹
/webapps文件夹	加入Jenkins.war 文件
备注：修改相应配置文件后需重启Tomcat才能生效。
5.1.5持续集成启动
5.1.5.1环境验证
相关配置完成后，先执行以下验证，判断环境是否搭建成功：
验证目标	验证方式/预期值
JDK	验证方式：运行->cmd,输入java –version
预期值： 返回java版本信息
Tomcat	验证方式：打开浏览器，访问
http://localhost:8080/，
点击server status，并在弹出登录窗口进行登录验证。
预期值：正确进入Tomcat管理页面。
Maven	登录Jenkins，在系统管理的全局管理界面出现Maven相关配置（该验证可在Jenkins启动后进行）
5.1.5.2启动Jenkins
第一步：启动Tomcat。
执行Tomcat文件夹下的bin/startup.bat批处理文件，启动Tomcat服务。
第二步：访问Jenkins。
待Tomcat服务启动成功后，访问http://localhost:8080/jenkins网址，打开Jenkins欢迎界面，如下图：
 
第三步：登录Jenkins。
首次进入Jenkins需要输入系统内置生成的管理员密码，密码默认存放在C:\Users\用户名\.jenkins\secrets目录下。
 
进入系统后，点击首页左侧【系统管理】菜单，打开右侧【管理用户】界面，在管理用户功能界面中新增一个管理员用户，用于后期登录和配置系统。
 
5.1.6全局环境配置
Jenkins正常运行前，需要先完成一些全局环境的配置，JDK和Maven是最基本的配置，其他工具的配置可以按具体工程需求逐渐加入：
（1）使用管理员账号登录Jenkins；
（2）依次点击首页左侧【系统管理】菜单，点击右侧【Global Tool Configuration】进入管理界面；
 
（3）详细配置如下内容（注意取消默认勾选项【自动安装】）：
	配置JDK：
 
	配置Maven：
  
5.1.7基本插件安装
在Jenkins平台上，很多复杂的任务都是借助插件来完成的，以下说明插件的安装方法：
（1）使用管理员账号登录Jenkins；
（2）依次点击首页左侧【系统管理】菜单，点击右侧【插件管理】进入插件安装和更新界面；
  
（3）如果Jenkins可以连接公网，点击【可更新】界面，直接勾选需要安装的插件即可进行下载和安装；
（4）如果Jenkins不能通过【可更新】界面下载安装插件，需点击【高级】进入插件安装界面执行手动安装。在下图插件上传区域依次选择在本地下载好的插件，并点击【上传】按钮执行上传和安装；
 
（5）手动安装插件时，请通过官网下载后缀名为*.hpi的插件：
https://updates.jenkins-ci.org/download/plugins/
（6）以下插件是测试部开展质量内建活动中已经在普遍使用的插件，初次安装时建议全部都安装上：
	FindBugs Plug-in  --用于静态代码扫描；
	Maven Integration plugin  --用于构建Maven工程；
	SSH Credentials Plugin  --用于自动部署；
	Subversion Plug-in  --用于连接SVN源码仓库；
（7）注意，安装完以上插件后，需要重新启动Jenkins，新插件才能生效。
5.2.	持续集成自动构建(开发工程师)
5.2.1新建项目
第一步：新建Job
（1）使用管理员分配的账号登录Jenkins平台；
（2）点击Jenkins首页左上角【新建】按钮，打开新建Job工作界面；
  
（3）输入项目名称，选择【构建一个Maven项目】并提交。
 
第二步：配置Job
新建Job成功后，在Job视图列表下，点击设置，进入该Job的配置页面。
  
（1）【General】的配置： 
	在【项目名称】输入项目名称，名称前缀请使用权限管理员分配的名称；
	勾选【丢弃旧的构建】；
	选择【strategy】为【log Rotation】；
	设置【保持构建的天数】和【保持构建的最大个数】。如：构建天数填写2，最大个数填写5，表示Jenkins最大保留构建2天内的构建记录，记录总数不超过5条，具体填写多少根据项目构建需求来决定；
 
（2）【源码管理】的配置
			配置SVN源码访问路径（首次配置需验证访问权限）
  
点击this link，在新页面内选择以用户名密码方式进行验证。
  
或者在有提示的情况下，进行身份验证，如图所示：
  
		设置【Check-out Strategy】为默认选项，如果需要每次构建都获取最新代码，应选择【Emulate clean checkout by first deleting unversioned/ignored files, then'svn update'】选项；
	 
（3）【构建触发器】的配置：
	勾选【Build whenever a SNAPSHOT dependency is built】选项；
	在构建整个工程依赖的最上游项目（如：parent）时，可勾选 【Build periodically】或【Poll SCM】选项，定制自动构建规则，该规则适用于正则表达式。两个选项的区别是：【Build periodically】表示无条件触发构建，【Poll SCM】表示源码有变更时才触发一次构建；下图中：H 7 * * *，表示每天早晨7点触发构建。
 
（4）【Build】的设置
	在【Root POM】中填写pom.xml；
	在【Goals and options】中填写构建代码，参见第3节增强构建部分。
 
设置完以上内容后，其他设置保持默认，点击保存，返回项目列表。
  
第三步：新建其他Job
重复上面第一步和第二步，依次新建其他Job工程，并完成相关配置。
5.2.2自动构建
第一步：手动构建新建的所有Job工程
在Job工程列表依次点击构建按钮，构建顺序遵从工程间的依赖关系，先构建上游工程，再构建下游工程。例如JUP的构建顺序是：
parent     entity     util     core      web
  
第二步：验证Job构建是否成功
检查列表中各个工程第一列的构建状态图标，如果是蓝色，表示本次构建成功，如果不是蓝色，表示构建失败，请联系管理员排查原因。
 
第三步：手动添加工程上下游触发规则
	从列表中最上游的parent工程进入配置界面
 
	切换到【构建后操作】页签
 
	点击【增加构建后操作步骤】
 		 
	选择【Build other projects】
 		 
	在【要构建的项目】中填写下游工程名称
	 
	点击【保存】返回列表
	依次配置其他工程的下游工程，对于JUP项目：
parent工程的下游工程填写：entity、util；
entity工程不做设置；
util工程的下游工程填写：core；
core工程的下游工程填写：web。
第四步：自动构建
	构建前确保第一步、第二步中所有工程构建是成功的，并检查第三步手动关联各工程的构建顺序是正确的；
	手动点击最上游工程的构建按钮，如parent工程，然后查看工程列表中其他工程是否被正确的按顺序触发构建；
	在最上游parent工程配置的触发时间点之后检查自动构建是否按时触发：检查方法是查看工程列表中的【上次成功】、【上次失败】、【上次持续时间】等内容是否和预期一致。如parent工程配置了早晨7点自动触发构建，那么在7点之后去检查是否已经由Jenkins自动触发了所有工程的构建。
 
5.2.3增强构建
以上自动构建配置成功以后，可以对项目添加静态代码扫描和单元测试执行报告了，以下是具体的配置方法：
（1）配置静态代码检查
	对于JUP项目，需要在core、web工程添加静态代码检查；
	打开具体工程的配置界面，在【Goals and options】中添加命令：
findbugs:findbugs
 
	【publish FindBugs analysis results】 
 
	在对应工程的pom文件中添加依赖的插件，并提交至源码仓库：
（2）执行静态代码检查
	配置好静态代码检查后，工程至少执行2次健康的构建；
	进入工程详情界面，查看静态代码检查生成的图表。
 
	点击左面【FindBugs Warnings】菜单进入静态代码详情展示界面 
 
	点击具体链接可以下钻并查看到具体问题代码段、问题说明和修改建议：
 
（3）配置单元测试扫描
	对于JUP项目，需要在core、web工程添加单元测试；
	单元测试不需要在Jenkins平台做特殊设置；
	在对应工程的pom文件中添加依赖的插件，并提交至源码仓库
 
（4）执行单元测试扫描
	执行配置有单元测试插件的Maven工程，完成健康构建；
	在工程列表点击并进入工程详情界面，查看单元测试扫描生成的图表；
 
5.3.	持续集成自动部署-Windows(开发工程师)
5.3.1环境准备
在Web工程对应的pom.xml文件中添加以下配置，指定部署服务器的Tomcat地址、账号和密码：
 
注意：如果Tomcat版本为1.7、1.8，pom文件url后需要加入“text”，否则不需要加入。
5.3.2工程配置
在Jenkins的Web工程设置中，新增构建步骤：
 
在新增的构建步骤中做以下设置：
 
注意：第一次自动部署时，命令填写为tomcat:deploy，自动部署成功后，再修改为tomcat:redeploy。
5.3.2自动部署
在项目视图列表下，选择最上游工程parent进行构建：
 
待所有工程构建完成后，检查Web工程的控制台打印信息，以下截图信息表示已经部署成功：
 
注意，部署成功只代表部署顺利完成，并不代表工程构建后自动打的war包也是正确的。为了验证打包是否正确，还需要访问部署应用的地址做进一步验证。
5.4.	持续集成自动部署-Linux(开发工程师)
在Linux平台进行自动部署，需要事先做好部署规划，然后在Jenkins平台按照一定顺序进行配置，大概过程和步骤如下：
	规划远程部署方案，主要考虑的是发布版本的更新和备份机制；
	在Jenkins安装支持Linux远程部署的相关插件；
	在Jenkins系统管理中配置与发布环境相关的参数；
	在工程构建的配置中引用由系统管理端设定的发布参数；
	执行和调试远程部署，访问应用程序地址确认发布成功。
下面分别对以上几个步骤进行详细说明。
5.4.1规划部署方案
在自动部署前，首先要针对当前项目或产品发布的特点，制定一个合理的远程部署方案，主要考虑以下几个方面：
（1）在Jenkins打好war包后，新包首先要发布到目标机器的哪个目录？
（2）原来旧有的war包如何进行备份？是每次都只备份上一次的，还是固定备份一段时间的版本？
（3）新、旧版本如何替换？如何避免出现重复的文件名？多余的版本如何删除？
（4）如何规划合理的目录结构，以最小的成本代价完成版本的更新和备份，满足当前的发布需求？
（5）如何用脚本实现当前规划的部署方案。
下面列举一种简单的脚本实现方式，实际发布时可参照此脚本进行灵活变更：
 
脚本编写好之后，进行如下操作：
（1）保存并命名为depoly.sh，并将该文件上传至目标发布机器上的指定目录下，以供Jenkins调用；
（2）在对应的目标机器中修改该目录文件的权限，参考命令：chmod 777；
（3）手动执行脚本，排查脚本中的语法错误和不可见的乱码情况；
（4）手动执行脚本，检查执行结果是否满足设计要求。
5.4.2安装部署插件
Jenkins完成Linux远程部署任务需要以下两个插件：deploy.hpi、publish-over-ssh.hpi,如果安装插件后系统管理界面提示不能使用，需要按照系统提示安装相应的依赖插件后才能正常使用，下载和安装方法参照第一章节插件安装部分。
5.4.3配置发布参数
基于上面的目录规划方案，在Jenkins中做如下具体配置：
（1）使用管理员账号登录Jenkins，打开【系统管理】菜单，进入【系统设置】模块：
  
（2）在【Publish over SSH】区域，对发布参数进行具体配置：
 
其中：
	【Name】是远程部署目标机器的名称，建议直接填写为对应的IP地址；
	【Hostname】填写远程部署机器的IP地址；
	【Username】填写登录远程部署机器的用户名，具有root权限；
	【Remote Directory】填写Jenkins直接发布到目标机器的war包地址。
（3）点击【高级】按钮，展开高级内容显示：
勾选【Use password authentication, or use a different key】单选框，并在【Passphrase / Password】中填写登录密码。
其他内容默认即可，不用修改。
  
  
（4）点击【Test Configuration】按钮，根据页面返回信息，判断当前配置的账号密码能否正确访问目标机器。
  
5.4.4引用发布参数
进入Web工程设置界面，在【增加构建后操作步骤】中新增一个构建后步骤【send file sartifacts over SSH】，如图所示：
   
打开【SSH Publishers】：
  
其中：
	【Name】选择系统设置中配置好的Name名称；
	【Source files】中填写在Jenkins服务器上默认的打包路径和文件名；
	【Remove prefix】中填写在Jenkins服务骑上删除历史打包版本所在的目录地址；
【Exec command】中填写远程部署脚本文件deploy.sh存放在目标机器的物理路径与文件名。
5.4.5调试自动部署
在项目视图列表下，选择最上游的parent工程进行构建：
 
待所有工程构建完成后，检查Web工程的控制台打印信息，检查.sh部署脚本是否正确执行，登录远程部署的目标机器查看war包是否上传到正确位置，查看应用部署地址的war包是否被正确备份和更新。
以下截图信息表示已经部署成功：
 
注意，部署成功只代表部署顺利完成，并不代表工程构建后自动打的war包也是正确的。为了验证打包是否正确，还需要进一步访问部署的应用地址做进一步验证。
